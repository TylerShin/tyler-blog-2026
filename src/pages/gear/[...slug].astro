---
import { type CollectionEntry, getCollection } from "astro:content";
import PageLayout from "@layouts/PageLayout.astro";
import TopLayout from "@layouts/TopLayout.astro";
import BottomLayout from "@layouts/BottomLayout.astro";
import { formatDate } from "@lib/utils";
import Giscus from "@components/Giscus";
import TranslationLinks from "@components/TranslationLinks.astro";
import { DEFAULT_LOCALE, getLocaleFromSlug, getTranslations } from "@lib/i18n";

// Create the static blog pages for default locale (ko)
export async function getStaticPaths() {
    const posts = await getCollection("gear");
    return posts
        .filter((post) => getLocaleFromSlug(post.slug) === DEFAULT_LOCALE)
        .map((post) => ({
            params: { slug: post.slug.replace(/^ko\//, "") },
            props: { post },
        }));
}

interface Props {
    post: CollectionEntry<"gear">;
}

const { post } = Astro.props;
const { title, summary, date, thumbnail, rating } = post.data;
const lang = post.data.lang || DEFAULT_LOCALE;
const translations = await getTranslations(post);
const { Content } = await post.render();

// Layout Logic for Prev/Next
const allGear = await getCollection("gear");
const items = allGear
    .filter((p) => getLocaleFromSlug(p.slug) === DEFAULT_LOCALE)
    .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());
const index = items.findIndex((x) => x.slug === post.slug);
const prev = items[(index - 1 + items.length) % items.length];
const next = items[(index + 1) % items.length];
---

<PageLayout title={title} description={summary} lang={lang} image={thumbnail}>
    <TopLayout>
        <div class="animate">
            {/* Top Header Section */}
            <div>
                <a
                    href="/gear"
                    class="group w-fit p-1.5 gap-1.5 text-sm flex items-center border rounded hover:bg-black/5 hover:dark:bg-white/10 border-black/15 dark:border-white/20 transition-colors duration-300 ease-in-out"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke-width="2.5"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        class="stroke-current group-hover:stroke-black group-hover:dark:stroke-white"
                    >
                        <line
                            x1="19"
                            y1="12"
                            x2="5"
                            y2="12"
                            class="scale-x-0 group-hover:scale-x-100 translate-x-3 group-hover:translate-x-0 transition-all duration-300 ease-in-out"
                        ></line>
                        <polyline
                            points="12 19 5 12 12 5"
                            class="translate-x-1 group-hover:translate-x-0 transition-all duration-300 ease-in-out"
                        ></polyline>
                    </svg>
                    <div
                        class="w-full group-hover:text-black group-hover:dark:text-white transition-colors duration-300 ease-in-out"
                    >
                        Back to gear
                    </div>
                </a>
                <div
                    class="flex flex-wrap text-sm uppercase mt-12 gap-3 opacity-75"
                >
                    <div class="flex items-center gap-2">
                        <svg class="size-5 stroke-current">
                            <use href="/ui.svg#calendar"></use>
                        </svg>
                        {formatDate(date)}
                    </div>
                </div>
                <h1
                    class="text-3xl font-semibold text-black dark:text-white mt-2"
                >
                    {title}
                </h1>
                {summary && <div class="mt-1">{summary}</div>}
                {rating && <div class="mt-1 text-yellow-500">â˜… {rating}</div>}
                {
                    thumbnail && (
                        <img
                            src={thumbnail}
                            alt={title || ""}
                            class="w-full h-auto rounded-lg mt-6"
                        />
                    )
                }
            </div>

            <TranslationLinks
                translations={translations}
                currentLocale={lang as any}
            />
        </div>
    </TopLayout>
    <BottomLayout>
        <div class="animate">
            <article class="prose dark:prose-invert">
                <Content />
            </article>

            {/* Navigation and Comments */}
            <div class="mt-8">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    {
                        prev && (
                            <a
                                href={`/gear/${prev.slug.replace(/^ko\//, "")}`}
                                class="group p-4 gap-3 flex items-center border rounded-lg hover:bg-black/5 hover:dark:bg-white/10 border-black/15 dark:border-white/20 blend"
                            >
                                <div class="order-2 w-full h-full group-hover:text-black group-hover:dark:text-white blend">
                                    <div class="flex flex-wrap gap-2">
                                        <div class="text-sm uppercase">
                                            Prev
                                        </div>
                                    </div>
                                    <div class="font-semibold mt-3 text-black dark:text-white">
                                        {prev.data.title}
                                    </div>
                                </div>
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="20"
                                    height="20"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke-width="2.5"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    class="order-1 stroke-current group-hover:stroke-black group-hover:dark:stroke-white rotate-180"
                                >
                                    <line
                                        x1="5"
                                        y1="12"
                                        x2="19"
                                        y2="12"
                                        class="scale-x-0 group-hover:scale-x-100 translate-x-4 group-hover:translate-x-1 transition-all duration-300 ease-in-out"
                                    />
                                    <polyline
                                        points="12 5 19 12 12 19"
                                        class="translate-x-0 group-hover:translate-x-1 transition-all duration-300 ease-in-out"
                                    />
                                </svg>
                            </a>
                        )
                    }
                    {
                        next && (
                            <a
                                href={`/gear/${next.slug.replace(/^ko\//, "")}`}
                                class="group p-4 gap-3 flex items-center border rounded-lg hover:bg-black/5 hover:dark:bg-white/10 border-black/15 dark:border-white/20 transition-colors duration-300 ease-in-out"
                            >
                                <div class="w-full h-full text-right group-hover:text-black group-hover:dark:text-white blend">
                                    <div class="text-sm uppercase">Next</div>
                                    <div class="font-semibold mt-3 text-black dark:text-white">
                                        {next.data.title}
                                    </div>
                                </div>
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="20"
                                    height="20"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke-width="2.5"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    class="stroke-current group-hover:stroke-black group-hover:dark:stroke-white"
                                >
                                    <line
                                        x1="5"
                                        y1="12"
                                        x2="19"
                                        y2="12"
                                        class="scale-x-0 group-hover:scale-x-100 translate-x-4 group-hover:translate-x-1 transition-all duration-300 ease-in-out"
                                    />
                                    <polyline
                                        points="12 5 19 12 12 19"
                                        class="translate-x-0 group-hover:translate-x-1 transition-all duration-300 ease-in-out"
                                    />
                                </svg>
                            </a>
                        )
                    }
                </div>
                <Giscus client:visible />
            </div>
        </div>
    </BottomLayout>
</PageLayout>
